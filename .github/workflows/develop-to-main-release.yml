name: Create PR from Develop to Main with Release

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  create-release-pr:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      # 1. Baixar a develop
      - name: Checkout develop branch
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      # 2. Obter a data e hora no formato yy.mm.dd.hhmm
      - name: Get current datetime
        id: date
        run: |
          DATE_FORMATTED=$(date -u +'%y.%m.%d.%H%M')
          echo "date=$DATE_FORMATTED" >> $GITHUB_OUTPUT
          echo "Current datetime: $DATE_FORMATTED"

      # 3. Encontrar as pastas v* e identificar a de nÃºmero maior
      - name: Identify latest version
        id: version
        run: |
          LATEST_VERSION=$(ls -d v*/ 2>/dev/null | sed 's#/##' | sort -V | tail -n1 || echo "v1")
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest version found: $LATEST_VERSION"

      # 4. Criar branch release/v*.yy.mm.dd.hhmm a partir da develop
      - name: Create release branch
        id: release_branch
        run: |
          RELEASE_BRANCH="release/${{ steps.version.outputs.latest_version }}.${{ steps.date.outputs.date }}"
          echo "branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "Creating branch: $RELEASE_BRANCH"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$RELEASE_BRANCH"

      # 5. Compactar a pasta v* maior em formato mud_html_v*.yy.mm.dd.hhmm.zip
      - name: Create version archive
        id: archive
        run: |
          ARCHIVE_NAME="mud_html_${{ steps.version.outputs.latest_version }}.${{ steps.date.outputs.date }}.zip"
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "Creating archive: $ARCHIVE_NAME"
          zip -r "$ARCHIVE_NAME" "${{ steps.version.outputs.latest_version }}"
          ls -lh *.zip

      # 6. Commitar "v* created"
      - name: Commit archive
        run: |
          git add "${{ steps.archive.outputs.archive_name }}"
          git commit -m "${{ steps.version.outputs.latest_version }} created"

      # 7. Criar a tag no formato v*.yy.mm.dd.hhmm
      - name: Create tag
        id: tag
        run: |
          TAG_NAME="${{ steps.version.outputs.latest_version }}.${{ steps.date.outputs.date }}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Creating tag: $TAG_NAME"
          git tag "$TAG_NAME"

      # 8. Fazer o push de tudo (branch + tag)
      - name: Push branch and tag
        run: |
          git push origin "${{ steps.release_branch.outputs.branch }}"
          git push origin "${{ steps.tag.outputs.tag }}"
          echo "Pushed branch and tag successfully"

      # 9. Criar o PR para a main
      - name: Check for existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_PR=$(gh pr list --head "${{ steps.release_branch.outputs.branch }}" --base main --json number --jq '.[0].number' || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "PR already exists: #$EXISTING_PR"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create Pull Request to Main
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Release ${{ steps.tag.outputs.tag }}" \
            --body "## ðŸš€ Release ${{ steps.tag.outputs.tag }}
            
            This PR was automatically created from the release branch.
            
            ### ðŸ“¦ Version
            **${{ steps.version.outputs.latest_version }}**
            
            ### ðŸ“… Release DateTime
            ${{ steps.date.outputs.date }} (UTC)
            
            ### ðŸ“¦ Archive
            \`${{ steps.archive.outputs.archive_name }}\`
            
            ### ðŸ·ï¸ Tag
            \`${{ steps.tag.outputs.tag }}\`
            
            ### âœ… Checklist
            - [ ] All tests passing
            - [ ] Documentation updated
            - [ ] Archive created and committed
            
            ---
            *This PR was automatically created by GitHub Actions*" \
            --base main \
            --head "${{ steps.release_branch.outputs.branch }}"

      - name: Summary
        run: |
          echo "## âœ… Release Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch**: ${{ steps.release_branch.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive**: ${{ steps.archive.outputs.archive_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: Ready for review and merge to main" >> $GITHUB_STEP_SUMMARY
